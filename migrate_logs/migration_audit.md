# 🗄️ DATABASE & MIGRATION AUDIT

**Tarih**: 20 Ekim 2025  
**Analiz**: Migrations, signals, database health

---

## 📋 MIGRATION DOSYALARI

### Toplam Migration Count
**Total**: 33 migration dosyası

### App Bazında Migration Sayısı

| App | Migration Sayısı | Son Migration |
|-----|------------------|---------------|
| accounts | 3 | 0002_user_birth_date_user_phone_address |
| stores | 4 | 0004_store_policy |
| listings | 5 | 0004_listing_location_indexes |
| catalog | 3 | 0002_product_brand_index |
| cart | 1 | 0001_initial |
| orders | 2 | 0001_initial + signals |
| reviews | 2 | 0001_initial + signals |
| messaging | 3 | 0002_thread_models |
| moderation | 3 | 0003_ban_model |
| payments | 1 | __init__ only (no migrations) |
| search | 2 | 0002_savedsearch_pricepoint |
| shipping | 1 | __init__ only (no migrations) |
| dashboards | 1 | __init__ only (no migrations) |
| core | 1 | __init__ only (no migrations) |

---

## 🔍 MIGRATION PATTERN ANALİZİ

### Initial Migrations (0001_initial.py)
**Toplam**: 11 app

**Örnek: accounts/migrations/0001_initial.py**
```python
# Generated by Django 5.2.7 on 2025-10-10 15:12
# Custom User model (AbstractUser)
# Fields: role, store_name, avatar, phone, birth_date
```

**Durum**: ✅ DOĞRU - Custom User modeli migration'da

---

### Index Migrations
**Örnekler**:
- `listings/0003_listing_attributes_indexes.py`
- `listings/0004_listing_location_indexes.py`
- `catalog/0002_product_brand_index.py`

**Analiz**: Performance optimizasyonları için index ekleme  
**Durum**: ✅ İYİ - Kritik search field'lerde index var

---

### Data Migrations
**Durum**: Görünür data migration yok (sadece schema)

**Güvenlik**: ✅ İYİ - Data migration risk yok

---

### Feature Migrations
**Örnekler**:
- `stores/0003_store_rating_fields.py` → rating_avg, rating_count
- `stores/0004_store_policy.py` → StorePolicy modeli
- `moderation/0003_ban_model.py` → Ban sistemi
- `search/0002_savedsearch_pricepoint.py` → SavedSearch, PricePoint

**Analiz**: Yeni feature'lar için migrations eklenmiş  
**Durum**: ✅ DOĞRU - Incremental development pattern

---

## 🔔 SIGNALS ANALİZİ

### accounts/signals.py

**Signal**: `post_save` on `User`  
**Action**: Seller role ise otomatik Store oluştur

```python
@receiver(post_save, sender=User)
def create_store_for_seller(sender, instance, created, **kwargs):
    if created and instance.role == 'seller':
        Store.objects.get_or_create(
            owner=instance,
            defaults={
                'name': f"{instance.username}'s Store",
                'slug': slugify(f"{instance.username}-store"),
            }
        )
```

**Durum**: ✅ DOĞRU  
**Risk**: YOK - get_or_create ile idempotent

---

### listings/signals.py

**Signal**: `post_save` on `Listing`  
**Action**: İlk PricePoint oluştur (feature flag kontrollü)

```python
@receiver(post_save, sender=Listing)
def create_initial_list_pricepoint(sender, instance, created, **kwargs):
    if not _ff('FEATURE_PRICE_HISTORY'):
        return
    if created:
        # İdempotent kontrolü
        exists = PricePoint.objects.filter(listing=instance, kind='list').exists()
        if not exists:
            PricePoint.objects.create(...)
```

**Durum**: ✅ DOĞRU  
**Risk**: YOK - Feature flag + idempotent check

---

### orders/signals.py

**Signal**: `post_save` on `Order`  
**Action**: Order paid olduğunda sale PricePoint oluştur

```python
@receiver(post_save, sender=Order)
def create_sale_pricepoints_on_paid(sender, instance, created, **kwargs):
    # Status=paid olduğunda
    # Her OrderItem için sale PricePoint oluştur
```

**Durum**: ✅ DOĞRU  
**Risk**: YOK - Feature flag kontrollü

---

### reviews/signals.py

**Signal**: `post_save`, `post_delete` on `Review`  
**Action**: Store rating'i yeniden hesapla

```python
def _recompute_store_rating(store: Store):
    agg = store.listings.aggregate(avg=Avg('reviews__rating'), cnt=Count('reviews'))
    # Store.rating_avg ve rating_count güncelle
```

**Durum**: ✅ DOĞRU  
**Performance**: ⚠️ Aggregate query her review'da çalışır  
**Öneri**: Cache veya async job ile optimize edilebilir (gelecek)

---

## 🔍 MIGRATION SAĞLIĞI

### Pending Migration Check

**Komut** (Bash):
```bash
cd ~/collectorium
source ~/virtualenv/collectorium/bin/activate
python manage.py makemigrations --check --dry-run
```

**Beklenen Sonuç**: No changes detected

**Eğer pending var**:
```bash
python manage.py makemigrations
python manage.py migrate
```

---

### Migration Plan

**Komut** (Bash):
```bash
python manage.py migrate --plan
```

**Beklenen Çıktı**: Tüm migrations uygulanmış, pending yok

**Örnek Çıktı**:
```
Planned operations:
(no pending migrations)
```

---

### Migration Execution

**İlk Deployment'ta** (boş DB):
```bash
# PostgreSQL/MySQL database'i oluştur
# Sonra:
python manage.py migrate --noinput
```

**Beklenen**: Tüm migrations apply olur (0001'den 000X'e)

**Süre**: ~30-60 saniye (DB hızına göre)

---

## 🗄️ DATABASE SENARYOLARI

### Senaryo 1: PostgreSQL (External)

**Setup**:
```bash
# External PostgreSQL instance (DigitalOcean, VPS, vs.)
DATABASE_URL=postgresql://user:pass@external-host:5432/collectorium_db
```

**Migration Flow**:
1. Boş DB oluştur
2. `python manage.py migrate`
3. Superuser: `python manage.py createsuperuser`
4. Test: `python scripts/test_db_connection.py`

**Avantajlar**:
- ✅ Tam PostgreSQL feature set
- ✅ Güçlü query optimizer
- ✅ JSON field desteği
- ✅ Migration uyumluluğu garantili

**Dezavantajlar**:
- ⚠️ External service dependency
- ⚠️ Network latency (minimal)
- ⚠️ Ekstra maliyet

**Önerilen**: Production için ideal ✅

---

### Senaryo 2: MySQL (cPanel Native)

**Setup**:
```bash
# cPanel → MySQL Databases
# 1. Database oluştur: username_collectorium
# 2. User oluştur + şifre
# 3. User'ı database'e ekle (ALL PRIVILEGES)

DATABASE_URL=mysql://cpanel_user:password@localhost:3306/username_collectorium
```

**Migration Flow**:
1. MySQL DB hazır
2. `python manage.py migrate`
3. ⚠️ Dikkat: Bazı migration'lar uyumsuz olabilir (JSON field, index tipleri)
4. Test: `python scripts/test_db_connection.py`

**Uyumluluk Kontrolleri**:
- ✅ CharField, TextField, IntegerField → Uyumlu
- ✅ ForeignKey, ManyToMany → Uyumlu
- ⚠️ JSONField → MySQL 5.7.8+ gerekli (genelde OK)
- ⚠️ Unique constraints → Test et
- ⚠️ Index creation → Test et

**Migration Test** (MySQL):
```bash
# Dry-run
python manage.py migrate --plan

# Execute
python manage.py migrate --noinput

# Verify
python manage.py dbshell
> SHOW TABLES;
> SELECT COUNT(*) FROM auth_user;
```

**Avantajlar**:
- ✅ cPanel native (kolay yönetim)
- ✅ Backup cPanel ile otomatik
- ✅ Ekstra maliyet yok

**Dezavantajlar**:
- ⚠️ Bazı PostgreSQL özelliklerinden yoksun
- ⚠️ Migration compatibility test gerekli

**Önerilen**: Test edilmiş + çalışıyorsa OK ✅

---

### Senaryo 3: SQLite (Development Only)

**Setup**: Default Django (db.sqlite3)

**Migration Flow**: Otomatik

**Durum**: ✅ Development için yeterli  
**Production**: ❌ KULLANILMAMALI

---

## 🔧 MIGRATION UYUMLULUK (PostgreSQL → MySQL)

### Uyumlu Özellikler ✅

| Feature | PostgreSQL | MySQL | Durum |
|---------|------------|-------|-------|
| CharField | ✅ | ✅ | ✅ Uyumlu |
| TextField | ✅ | ✅ | ✅ Uyumlu |
| IntegerField | ✅ | ✅ | ✅ Uyumlu |
| DecimalField | ✅ | ✅ | ✅ Uyumlu |
| DateTimeField | ✅ | ✅ | ✅ Uyumlu |
| ForeignKey | ✅ | ✅ | ✅ Uyumlu |
| ManyToManyField | ✅ | ✅ | ✅ Uyumlu |
| ImageField/FileField | ✅ | ✅ | ✅ Uyumlu |
| BooleanField | ✅ | ✅ | ✅ Uyumlu |
| JSONField | ✅ (native) | ✅ (5.7.8+) | ✅ Uyumlu |

---

### Dikkat Gerektiren Özellikler ⚠️

| Feature | PostgreSQL | MySQL | Not |
|---------|------------|-------|-----|
| BigAutoField | ✅ | ✅ | Test et |
| UniqueConstraint (with condition) | ✅ | ⚠️ Partial index yok | messaging/Thread model |
| Index (complex) | ✅ | ⚠️ Bazı tipler farklı | Test et |
| Full-text search | ✅ (native) | ⚠️ (farklı syntax) | Kullanılmıyor |

---

### Kritik Uyumsuzluk: messaging.Thread UniqueConstraint

**PostgreSQL Migration**:
```python
models.UniqueConstraint(
    fields=['listing', 'buyer', 'seller'],
    condition=Q(is_open=True),
    name='uniq_open_thread_per_listing_buyer_seller',
)
```

**MySQL Problem**: ⚠️ Conditional unique constraint desteklenmiyor

**Çözüm Seçenekleri**:
1. **Ignore** (warning verir ama migration çalışır, constraint skip edilir)
2. **Custom migration** (MySQL için unique index + trigger)
3. **Application-level check** (model save'de kontrol)

**Risk**: ORTA - Duplicate thread oluşabilir (MySQL'de)

**Öneri**: PostgreSQL kullan VEYA application-level check ekle

---

## 📊 MIGRATION SIRA ANALİZİ

### Migration Dependencies (Örnekler)

**accounts** → **stores** (User → Store FK)
```
accounts.0001_initial → stores.0001_initial
```

**stores** → **listings** (Store → Listing FK)
```
stores.0001_initial → listings.0001_initial
```

**listings** → **reviews** (Listing → Review FK)
```
listings.0001_initial → reviews.0001_initial
```

**Durum**: ✅ DOĞRU - Dependencies migration'larda belirtilmiş

---

## 🔔 SIGNAL HEALTH ANALİZİ

### accounts/signals.py

**Signal**: User created → Store oluştur (seller ise)

**Risk Analizi**:
- ✅ Idempotent (get_or_create)
- ✅ Sadece created=True'da çalışır
- ✅ Role check var
- ⚠️ Slug collision riski (düşük, slugify kullanılıyor)

**Test**:
```python
# User oluştur
user = User.objects.create(username='test', role='seller')
# Store otomatik oluşmalı
assert user.owned_stores.exists()
```

---

### listings/signals.py

**Signal**: Listing created → PricePoint oluştur (feature flag kontrollü)

**Risk Analizi**:
- ✅ Feature flag kontrolü (FEATURE_PRICE_HISTORY)
- ✅ Idempotent check (exists kontrolü)
- ✅ Sadece created=True'da çalışır
- ✅ Performance: Minimal (1 query)

**Feature Flag**: `FEATURE_PRICE_HISTORY` (env var)

---

### orders/signals.py

**Signal**: Order status=paid → Sale PricePoint oluştur

**Risk Analizi**:
- ✅ Feature flag kontrolü
- ✅ Status check (sadece paid olunca)
- ⚠️ N+1 query riski (her OrderItem için PricePoint)
- **Öneri**: Bulk create ile optimize edilebilir

**Feature Flag**: `FEATURE_PRICE_HISTORY`

---

### reviews/signals.py

**Signal**: Review save/delete → Store rating yeniden hesapla

**Risk Analizi**:
- ✅ Feature flag kontrolü (FEATURE_STORE_REVIEWS)
- ⚠️ Performance: Aggregate query her review'da
- ⚠️ N+1 riski: Store.listings.aggregate()
- **Öneri**: Cache veya async job ile optimize et

**Performance Impact**: Her review'da ~1-2 query ekstra

---

## 🧪 TEST SENARYOLARI

### Test Senaryosu 1: Fresh PostgreSQL Database

**Komutlar** (Bash):
```bash
# 1. Environment ayarla
export DJANGO_SETTINGS_MODULE=collectorium.settings.hosting
export DATABASE_URL=postgresql://user:pass@host:5432/collectorium_db
export SECRET_KEY=test-key-for-migration
export ALLOWED_HOSTS=localhost
export CSRF_TRUSTED_ORIGINS=https://localhost

# 2. Test database connection
python scripts/test_db_connection.py

# 3. Check pending migrations
python manage.py makemigrations --check --dry-run

# 4. Show migration plan
python manage.py migrate --plan

# 5. Apply migrations
python manage.py migrate --noinput

# 6. Create superuser
python manage.py createsuperuser

# 7. Verify tables
python manage.py dbshell
\dt  # List tables
SELECT COUNT(*) FROM accounts_user;
\q
```

**Beklenen Sonuç**: Tüm migrations başarılı, tüm tablolar oluştu

---

### Test Senaryosu 2: Fresh MySQL Database

**Komutlar** (Bash):
```bash
# 1. cPanel'de MySQL DB oluştur
# 2. Environment ayarla
export DJANGO_SETTINGS_MODULE=collectorium.settings.hosting
export DATABASE_URL=mysql://user:pass@localhost:3306/collectorium_db
export SECRET_KEY=test-key-for-migration
export ALLOWED_HOSTS=localhost
export CSRF_TRUSTED_ORIGINS=https://localhost

# 3. Test database connection
python scripts/test_db_connection.py

# 4. Check if MySQLdb available
python -c "import MySQLdb; print('MySQLdb OK')"

# 5. Show migration plan
python manage.py migrate --plan

# 6. Apply migrations (dikkatli!)
python manage.py migrate --noinput

# 7. Check for errors
echo $?  # Should be 0

# 8. Verify tables
python manage.py dbshell
SHOW TABLES;
SELECT COUNT(*) FROM accounts_user;
EXIT;
```

**Beklenen Sonuç**: Migrations apply olur (conditional constraint warning olabilir)

**Dikkat**: UniqueConstraint(condition=...) MySQL'de skip edilir

---

### Test Senaryosu 3: SQLite (Local Development)

**Komutlar** (PowerShell):
```powershell
# 1. Environment ayarla
$env:DJANGO_SETTINGS_MODULE="collectorium.settings.dev"
$env:DATABASE_URL="sqlite:///db.sqlite3"

# 2. Show migration plan
python manage.py migrate --plan

# 3. Apply migrations
python manage.py migrate --noinput

# 4. Create superuser
python manage.py createsuperuser

# 5. Run dev server
python manage.py runserver
```

**Beklenen Sonuç**: Development'ta sorunsuz çalışır

---

## 🗄️ DATA MIGRATION PLAN (Render → cPanel)

### PostgreSQL → PostgreSQL (Tercih Edilen)

**Method**: pg_dump + pg_restore

**Komutlar**:
```bash
# Render'dan export
pg_dump $RENDER_DATABASE_URL > render_backup.sql

# cPanel'e import (SSH ile)
cd ~/collectorium
psql $DATABASE_URL < render_backup.sql
```

**Risk**: DÜŞÜK - Aynı engine, tam uyumluluk

---

### PostgreSQL → MySQL (Alternatif)

**Method 1**: Django dumpdata/loaddata

**Komutlar** (Render'da):
```bash
python manage.py dumpdata \
  --natural-foreign \
  --natural-primary \
  --exclude auth.permission \
  --exclude contenttypes \
  --exclude sessions \
  --output render_data.json
```

**Komutlar** (cPanel MySQL'de):
```bash
cd ~/collectorium
source ~/virtualenv/collectorium/bin/activate

# Fresh migrate
python manage.py migrate --noinput

# Load data
python manage.py loaddata render_data.json
```

**Dikkat Noktaları**:
- ⚠️ BigAutoField ID sequence'ları kontrol et
- ⚠️ JSONField data formatting
- ⚠️ Unique constraint ihlalleri

**Risk**: ORTA - Test edilmeli

---

**Method 2**: Custom migration script

```python
# scripts/migrate_postgres_to_mysql.py
# Her model için:
# 1. PostgreSQL'den fetch
# 2. MySQL'e bulk_create
# 3. Foreign key ID'leri map et
```

**Risk**: YÜKSEK - Kompleks, hata riski

**Öneri**: Method 1 (dumpdata/loaddata) tercih et

---

## 📋 MODEL-MIGRATION TUTARLILIĞI

### Kontrol Listesi

**Tüm modeller için migration var mı?**

| App | Model Sayısı | Migration Dosyası | Durum |
|-----|--------------|------------------|-------|
| accounts | 3 | 3 migration | ✅ |
| stores | 2 | 4 migration | ✅ |
| listings | 3 | 5 migration | ✅ |
| catalog | 2 | 3 migration | ✅ |
| cart | 0 | 1 migration (empty) | ✅ Session-based |
| orders | 2 | 2 migration | ✅ |
| reviews | 1 | 2 migration | ✅ |
| messaging | 3 | 3 migration | ✅ |
| moderation | 4 | 3 migration | ✅ |
| payments | 5 | 1 migration (__init__) | ⚠️ |
| search | 2 | 2 migration | ✅ |
| shipping | 0 | 1 migration (empty) | ✅ Boş app |
| dashboards | 0 | 1 migration (empty) | ✅ Boş app |
| core | 0 | 1 migration (empty) | ✅ Model yok |

**Dikkat**: payments app'te 5 model var ama sadece __init__.py migration  
**Durum**: ⚠️ KONTROL ET - Pending migration olabilir

**Kontrol Komutu**:
```bash
python manage.py makemigrations payments --check
```

**Beklenen**: No changes detected VEYA pending migration varsa oluştur

---

## 🚨 BULGULAR & RİSKLER

### KRİTİK SORUNLAR

1. **payments app migration eksikliği**
   - **Durum**: ⚠️ 5 model var, migration __init__ only
   - **Risk**: YÜKSEK - DB'de tablo olmayabilir
   - **Çözüm**: `python manage.py makemigrations payments`
   - **Test**: `python manage.py migrate --plan`

---

### ORTA RİSKLER

2. **MySQL UniqueConstraint compatibility**
   - **Model**: messaging.Thread
   - **Durum**: Conditional unique constraint MySQL'de desteklenmez
   - **Risk**: ORTA - Duplicate thread oluşabilir
   - **Çözüm**: PostgreSQL kullan VEYA application-level check

3. **Review signal performance**
   - **Durum**: Her review'da aggregate query
   - **Risk**: DÜŞÜK - Yavaşlık (çok review varsa)
   - **Öneri**: Cache veya async optimize

---

### DÜŞÜK RİSKLER

4. **Signal idempotency**
   - **Durum**: ✅ Kontroller mevcut
   - **Risk**: YOK

5. **Migration rollback**
   - **Durum**: Django migration rollback destekliyor
   - **Risk**: Düşük - Data migration yoksa güvenli

---

## ✅ ÖNERİLER

### YÜKSEK ÖNCELİK

1. **payments app migration kontrolü**
   ```bash
   python manage.py makemigrations payments --check
   # Eğer pending var:
   python manage.py makemigrations payments
   ```

2. **Migration plan kontrolü**
   ```bash
   python manage.py migrate --plan
   # Pending yok olmalı
   ```

---

### ORTA ÖNCELİK

3. **MySQL kullanıyorsan**: Conditional unique constraint test et
   ```bash
   # messaging.Thread duplicate oluşturma testi
   # Application-level validation ekle
   ```

4. **Performance**: Review signal'i optimize et
   - Cache store rating
   - Async job ile hesapla

---

### DÜŞÜK ÖNCELİK

5. **Data migration** (Render → cPanel):
   - Test dumpdata/loaddata flow
   - Backup oluştur

---

## 🎯 DOĞRULAMA KOMUTLARI

### Bash (cPanel)
```bash
# Migration status
python manage.py showmigrations

# Pending check
python manage.py makemigrations --check --dry-run

# Migration plan
python manage.py migrate --plan

# Database connection test
python scripts/test_db_connection.py
```

### PowerShell (Local)
```powershell
# Migration status
python manage.py showmigrations

# Pending check
python manage.py makemigrations --check --dry-run

# Migration plan
python manage.py migrate --plan
```

---

## ✅ SONUÇ

**Migration Health**: ✅ **İYİ** (payments kontrol edilmeli)  
**Signal Safety**: ✅ **GÜVENLI** (idempotent)  
**PostgreSQL Ready**: ✅ **TAM UYUMLU**  
**MySQL Ready**: ⚠️ **TEST GEREKLİ** (UniqueConstraint)

**Kritik Sorun**: 1 (payments migration check)  
**Orta Risk**: 2 (MySQL uyumluluk, performance)  
**Düşük Risk**: 2 (data migration, signal optimize)

**GO/NO-GO**: ✅ **GO** (payments migration check sonrası)

---

**Hazırlayan**: AI Assistant  
**Tarih**: 2025-10-20  
**Durum**: TAMAMLANDI ✅


