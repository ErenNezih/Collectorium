# ðŸ—„ï¸ DATABASE & MIGRATION AUDIT

**Tarih**: 20 Ekim 2025  
**Analiz**: Migrations, signals, database health

---

## ðŸ“‹ MIGRATION DOSYALARI

### Toplam Migration Count
**Total**: 33 migration dosyasÄ±

### App BazÄ±nda Migration SayÄ±sÄ±

| App | Migration SayÄ±sÄ± | Son Migration |
|-----|------------------|---------------|
| accounts | 3 | 0002_user_birth_date_user_phone_address |
| stores | 4 | 0004_store_policy |
| listings | 5 | 0004_listing_location_indexes |
| catalog | 3 | 0002_product_brand_index |
| cart | 1 | 0001_initial |
| orders | 2 | 0001_initial + signals |
| reviews | 2 | 0001_initial + signals |
| messaging | 3 | 0002_thread_models |
| moderation | 3 | 0003_ban_model |
| payments | 1 | __init__ only (no migrations) |
| search | 2 | 0002_savedsearch_pricepoint |
| shipping | 1 | __init__ only (no migrations) |
| dashboards | 1 | __init__ only (no migrations) |
| core | 1 | __init__ only (no migrations) |

---

## ðŸ” MIGRATION PATTERN ANALÄ°ZÄ°

### Initial Migrations (0001_initial.py)
**Toplam**: 11 app

**Ã–rnek: accounts/migrations/0001_initial.py**
```python
# Generated by Django 5.2.7 on 2025-10-10 15:12
# Custom User model (AbstractUser)
# Fields: role, store_name, avatar, phone, birth_date
```

**Durum**: âœ… DOÄžRU - Custom User modeli migration'da

---

### Index Migrations
**Ã–rnekler**:
- `listings/0003_listing_attributes_indexes.py`
- `listings/0004_listing_location_indexes.py`
- `catalog/0002_product_brand_index.py`

**Analiz**: Performance optimizasyonlarÄ± iÃ§in index ekleme  
**Durum**: âœ… Ä°YÄ° - Kritik search field'lerde index var

---

### Data Migrations
**Durum**: GÃ¶rÃ¼nÃ¼r data migration yok (sadece schema)

**GÃ¼venlik**: âœ… Ä°YÄ° - Data migration risk yok

---

### Feature Migrations
**Ã–rnekler**:
- `stores/0003_store_rating_fields.py` â†’ rating_avg, rating_count
- `stores/0004_store_policy.py` â†’ StorePolicy modeli
- `moderation/0003_ban_model.py` â†’ Ban sistemi
- `search/0002_savedsearch_pricepoint.py` â†’ SavedSearch, PricePoint

**Analiz**: Yeni feature'lar iÃ§in migrations eklenmiÅŸ  
**Durum**: âœ… DOÄžRU - Incremental development pattern

---

## ðŸ”” SIGNALS ANALÄ°ZÄ°

### accounts/signals.py

**Signal**: `post_save` on `User`  
**Action**: Seller role ise otomatik Store oluÅŸtur

```python
@receiver(post_save, sender=User)
def create_store_for_seller(sender, instance, created, **kwargs):
    if created and instance.role == 'seller':
        Store.objects.get_or_create(
            owner=instance,
            defaults={
                'name': f"{instance.username}'s Store",
                'slug': slugify(f"{instance.username}-store"),
            }
        )
```

**Durum**: âœ… DOÄžRU  
**Risk**: YOK - get_or_create ile idempotent

---

### listings/signals.py

**Signal**: `post_save` on `Listing`  
**Action**: Ä°lk PricePoint oluÅŸtur (feature flag kontrollÃ¼)

```python
@receiver(post_save, sender=Listing)
def create_initial_list_pricepoint(sender, instance, created, **kwargs):
    if not _ff('FEATURE_PRICE_HISTORY'):
        return
    if created:
        # Ä°dempotent kontrolÃ¼
        exists = PricePoint.objects.filter(listing=instance, kind='list').exists()
        if not exists:
            PricePoint.objects.create(...)
```

**Durum**: âœ… DOÄžRU  
**Risk**: YOK - Feature flag + idempotent check

---

### orders/signals.py

**Signal**: `post_save` on `Order`  
**Action**: Order paid olduÄŸunda sale PricePoint oluÅŸtur

```python
@receiver(post_save, sender=Order)
def create_sale_pricepoints_on_paid(sender, instance, created, **kwargs):
    # Status=paid olduÄŸunda
    # Her OrderItem iÃ§in sale PricePoint oluÅŸtur
```

**Durum**: âœ… DOÄžRU  
**Risk**: YOK - Feature flag kontrollÃ¼

---

### reviews/signals.py

**Signal**: `post_save`, `post_delete` on `Review`  
**Action**: Store rating'i yeniden hesapla

```python
def _recompute_store_rating(store: Store):
    agg = store.listings.aggregate(avg=Avg('reviews__rating'), cnt=Count('reviews'))
    # Store.rating_avg ve rating_count gÃ¼ncelle
```

**Durum**: âœ… DOÄžRU  
**Performance**: âš ï¸ Aggregate query her review'da Ã§alÄ±ÅŸÄ±r  
**Ã–neri**: Cache veya async job ile optimize edilebilir (gelecek)

---

## ðŸ” MIGRATION SAÄžLIÄžI

### Pending Migration Check

**Komut** (Bash):
```bash
cd ~/collectorium
source ~/virtualenv/collectorium/bin/activate
python manage.py makemigrations --check --dry-run
```

**Beklenen SonuÃ§**: No changes detected

**EÄŸer pending var**:
```bash
python manage.py makemigrations
python manage.py migrate
```

---

### Migration Plan

**Komut** (Bash):
```bash
python manage.py migrate --plan
```

**Beklenen Ã‡Ä±ktÄ±**: TÃ¼m migrations uygulanmÄ±ÅŸ, pending yok

**Ã–rnek Ã‡Ä±ktÄ±**:
```
Planned operations:
(no pending migrations)
```

---

### Migration Execution

**Ä°lk Deployment'ta** (boÅŸ DB):
```bash
# PostgreSQL/MySQL database'i oluÅŸtur
# Sonra:
python manage.py migrate --noinput
```

**Beklenen**: TÃ¼m migrations apply olur (0001'den 000X'e)

**SÃ¼re**: ~30-60 saniye (DB hÄ±zÄ±na gÃ¶re)

---

## ðŸ—„ï¸ DATABASE SENARYOLARI

### Senaryo 1: PostgreSQL (External)

**Setup**:
```bash
# External PostgreSQL instance (DigitalOcean, VPS, vs.)
DATABASE_URL=postgresql://user:pass@external-host:5432/collectorium_db
```

**Migration Flow**:
1. BoÅŸ DB oluÅŸtur
2. `python manage.py migrate`
3. Superuser: `python manage.py createsuperuser`
4. Test: `python scripts/test_db_connection.py`

**Avantajlar**:
- âœ… Tam PostgreSQL feature set
- âœ… GÃ¼Ã§lÃ¼ query optimizer
- âœ… JSON field desteÄŸi
- âœ… Migration uyumluluÄŸu garantili

**Dezavantajlar**:
- âš ï¸ External service dependency
- âš ï¸ Network latency (minimal)
- âš ï¸ Ekstra maliyet

**Ã–nerilen**: Production iÃ§in ideal âœ…

---

### Senaryo 2: MySQL (cPanel Native)

**Setup**:
```bash
# cPanel â†’ MySQL Databases
# 1. Database oluÅŸtur: username_collectorium
# 2. User oluÅŸtur + ÅŸifre
# 3. User'Ä± database'e ekle (ALL PRIVILEGES)

DATABASE_URL=mysql://cpanel_user:password@localhost:3306/username_collectorium
```

**Migration Flow**:
1. MySQL DB hazÄ±r
2. `python manage.py migrate`
3. âš ï¸ Dikkat: BazÄ± migration'lar uyumsuz olabilir (JSON field, index tipleri)
4. Test: `python scripts/test_db_connection.py`

**Uyumluluk Kontrolleri**:
- âœ… CharField, TextField, IntegerField â†’ Uyumlu
- âœ… ForeignKey, ManyToMany â†’ Uyumlu
- âš ï¸ JSONField â†’ MySQL 5.7.8+ gerekli (genelde OK)
- âš ï¸ Unique constraints â†’ Test et
- âš ï¸ Index creation â†’ Test et

**Migration Test** (MySQL):
```bash
# Dry-run
python manage.py migrate --plan

# Execute
python manage.py migrate --noinput

# Verify
python manage.py dbshell
> SHOW TABLES;
> SELECT COUNT(*) FROM auth_user;
```

**Avantajlar**:
- âœ… cPanel native (kolay yÃ¶netim)
- âœ… Backup cPanel ile otomatik
- âœ… Ekstra maliyet yok

**Dezavantajlar**:
- âš ï¸ BazÄ± PostgreSQL Ã¶zelliklerinden yoksun
- âš ï¸ Migration compatibility test gerekli

**Ã–nerilen**: Test edilmiÅŸ + Ã§alÄ±ÅŸÄ±yorsa OK âœ…

---

### Senaryo 3: SQLite (Development Only)

**Setup**: Default Django (db.sqlite3)

**Migration Flow**: Otomatik

**Durum**: âœ… Development iÃ§in yeterli  
**Production**: âŒ KULLANILMAMALI

---

## ðŸ”§ MIGRATION UYUMLULUK (PostgreSQL â†’ MySQL)

### Uyumlu Ã–zellikler âœ…

| Feature | PostgreSQL | MySQL | Durum |
|---------|------------|-------|-------|
| CharField | âœ… | âœ… | âœ… Uyumlu |
| TextField | âœ… | âœ… | âœ… Uyumlu |
| IntegerField | âœ… | âœ… | âœ… Uyumlu |
| DecimalField | âœ… | âœ… | âœ… Uyumlu |
| DateTimeField | âœ… | âœ… | âœ… Uyumlu |
| ForeignKey | âœ… | âœ… | âœ… Uyumlu |
| ManyToManyField | âœ… | âœ… | âœ… Uyumlu |
| ImageField/FileField | âœ… | âœ… | âœ… Uyumlu |
| BooleanField | âœ… | âœ… | âœ… Uyumlu |
| JSONField | âœ… (native) | âœ… (5.7.8+) | âœ… Uyumlu |

---

### Dikkat Gerektiren Ã–zellikler âš ï¸

| Feature | PostgreSQL | MySQL | Not |
|---------|------------|-------|-----|
| BigAutoField | âœ… | âœ… | Test et |
| UniqueConstraint (with condition) | âœ… | âš ï¸ Partial index yok | messaging/Thread model |
| Index (complex) | âœ… | âš ï¸ BazÄ± tipler farklÄ± | Test et |
| Full-text search | âœ… (native) | âš ï¸ (farklÄ± syntax) | KullanÄ±lmÄ±yor |

---

### Kritik Uyumsuzluk: messaging.Thread UniqueConstraint

**PostgreSQL Migration**:
```python
models.UniqueConstraint(
    fields=['listing', 'buyer', 'seller'],
    condition=Q(is_open=True),
    name='uniq_open_thread_per_listing_buyer_seller',
)
```

**MySQL Problem**: âš ï¸ Conditional unique constraint desteklenmiyor

**Ã‡Ã¶zÃ¼m SeÃ§enekleri**:
1. **Ignore** (warning verir ama migration Ã§alÄ±ÅŸÄ±r, constraint skip edilir)
2. **Custom migration** (MySQL iÃ§in unique index + trigger)
3. **Application-level check** (model save'de kontrol)

**Risk**: ORTA - Duplicate thread oluÅŸabilir (MySQL'de)

**Ã–neri**: PostgreSQL kullan VEYA application-level check ekle

---

## ðŸ“Š MIGRATION SIRA ANALÄ°ZÄ°

### Migration Dependencies (Ã–rnekler)

**accounts** â†’ **stores** (User â†’ Store FK)
```
accounts.0001_initial â†’ stores.0001_initial
```

**stores** â†’ **listings** (Store â†’ Listing FK)
```
stores.0001_initial â†’ listings.0001_initial
```

**listings** â†’ **reviews** (Listing â†’ Review FK)
```
listings.0001_initial â†’ reviews.0001_initial
```

**Durum**: âœ… DOÄžRU - Dependencies migration'larda belirtilmiÅŸ

---

## ðŸ”” SIGNAL HEALTH ANALÄ°ZÄ°

### accounts/signals.py

**Signal**: User created â†’ Store oluÅŸtur (seller ise)

**Risk Analizi**:
- âœ… Idempotent (get_or_create)
- âœ… Sadece created=True'da Ã§alÄ±ÅŸÄ±r
- âœ… Role check var
- âš ï¸ Slug collision riski (dÃ¼ÅŸÃ¼k, slugify kullanÄ±lÄ±yor)

**Test**:
```python
# User oluÅŸtur
user = User.objects.create(username='test', role='seller')
# Store otomatik oluÅŸmalÄ±
assert user.owned_stores.exists()
```

---

### listings/signals.py

**Signal**: Listing created â†’ PricePoint oluÅŸtur (feature flag kontrollÃ¼)

**Risk Analizi**:
- âœ… Feature flag kontrolÃ¼ (FEATURE_PRICE_HISTORY)
- âœ… Idempotent check (exists kontrolÃ¼)
- âœ… Sadece created=True'da Ã§alÄ±ÅŸÄ±r
- âœ… Performance: Minimal (1 query)

**Feature Flag**: `FEATURE_PRICE_HISTORY` (env var)

---

### orders/signals.py

**Signal**: Order status=paid â†’ Sale PricePoint oluÅŸtur

**Risk Analizi**:
- âœ… Feature flag kontrolÃ¼
- âœ… Status check (sadece paid olunca)
- âš ï¸ N+1 query riski (her OrderItem iÃ§in PricePoint)
- **Ã–neri**: Bulk create ile optimize edilebilir

**Feature Flag**: `FEATURE_PRICE_HISTORY`

---

### reviews/signals.py

**Signal**: Review save/delete â†’ Store rating yeniden hesapla

**Risk Analizi**:
- âœ… Feature flag kontrolÃ¼ (FEATURE_STORE_REVIEWS)
- âš ï¸ Performance: Aggregate query her review'da
- âš ï¸ N+1 riski: Store.listings.aggregate()
- **Ã–neri**: Cache veya async job ile optimize et

**Performance Impact**: Her review'da ~1-2 query ekstra

---

## ðŸ§ª TEST SENARYOLARI

### Test Senaryosu 1: Fresh PostgreSQL Database

**Komutlar** (Bash):
```bash
# 1. Environment ayarla
export DJANGO_SETTINGS_MODULE=collectorium.settings.hosting
export DATABASE_URL=postgresql://user:pass@host:5432/collectorium_db
export SECRET_KEY=test-key-for-migration
export ALLOWED_HOSTS=localhost
export CSRF_TRUSTED_ORIGINS=https://localhost

# 2. Test database connection
python scripts/test_db_connection.py

# 3. Check pending migrations
python manage.py makemigrations --check --dry-run

# 4. Show migration plan
python manage.py migrate --plan

# 5. Apply migrations
python manage.py migrate --noinput

# 6. Create superuser
python manage.py createsuperuser

# 7. Verify tables
python manage.py dbshell
\dt  # List tables
SELECT COUNT(*) FROM accounts_user;
\q
```

**Beklenen SonuÃ§**: TÃ¼m migrations baÅŸarÄ±lÄ±, tÃ¼m tablolar oluÅŸtu

---

### Test Senaryosu 2: Fresh MySQL Database

**Komutlar** (Bash):
```bash
# 1. cPanel'de MySQL DB oluÅŸtur
# 2. Environment ayarla
export DJANGO_SETTINGS_MODULE=collectorium.settings.hosting
export DATABASE_URL=mysql://user:pass@localhost:3306/collectorium_db
export SECRET_KEY=test-key-for-migration
export ALLOWED_HOSTS=localhost
export CSRF_TRUSTED_ORIGINS=https://localhost

# 3. Test database connection
python scripts/test_db_connection.py

# 4. Check if MySQLdb available
python -c "import MySQLdb; print('MySQLdb OK')"

# 5. Show migration plan
python manage.py migrate --plan

# 6. Apply migrations (dikkatli!)
python manage.py migrate --noinput

# 7. Check for errors
echo $?  # Should be 0

# 8. Verify tables
python manage.py dbshell
SHOW TABLES;
SELECT COUNT(*) FROM accounts_user;
EXIT;
```

**Beklenen SonuÃ§**: Migrations apply olur (conditional constraint warning olabilir)

**Dikkat**: UniqueConstraint(condition=...) MySQL'de skip edilir

---

### Test Senaryosu 3: SQLite (Local Development)

**Komutlar** (PowerShell):
```powershell
# 1. Environment ayarla
$env:DJANGO_SETTINGS_MODULE="collectorium.settings.dev"
$env:DATABASE_URL="sqlite:///db.sqlite3"

# 2. Show migration plan
python manage.py migrate --plan

# 3. Apply migrations
python manage.py migrate --noinput

# 4. Create superuser
python manage.py createsuperuser

# 5. Run dev server
python manage.py runserver
```

**Beklenen SonuÃ§**: Development'ta sorunsuz Ã§alÄ±ÅŸÄ±r

---

## ðŸ—„ï¸ DATA MIGRATION PLAN (Render â†’ cPanel)

### PostgreSQL â†’ PostgreSQL (Tercih Edilen)

**Method**: pg_dump + pg_restore

**Komutlar**:
```bash
# Render'dan export
pg_dump $RENDER_DATABASE_URL > render_backup.sql

# cPanel'e import (SSH ile)
cd ~/collectorium
psql $DATABASE_URL < render_backup.sql
```

**Risk**: DÃœÅžÃœK - AynÄ± engine, tam uyumluluk

---

### PostgreSQL â†’ MySQL (Alternatif)

**Method 1**: Django dumpdata/loaddata

**Komutlar** (Render'da):
```bash
python manage.py dumpdata \
  --natural-foreign \
  --natural-primary \
  --exclude auth.permission \
  --exclude contenttypes \
  --exclude sessions \
  --output render_data.json
```

**Komutlar** (cPanel MySQL'de):
```bash
cd ~/collectorium
source ~/virtualenv/collectorium/bin/activate

# Fresh migrate
python manage.py migrate --noinput

# Load data
python manage.py loaddata render_data.json
```

**Dikkat NoktalarÄ±**:
- âš ï¸ BigAutoField ID sequence'larÄ± kontrol et
- âš ï¸ JSONField data formatting
- âš ï¸ Unique constraint ihlalleri

**Risk**: ORTA - Test edilmeli

---

**Method 2**: Custom migration script

```python
# scripts/migrate_postgres_to_mysql.py
# Her model iÃ§in:
# 1. PostgreSQL'den fetch
# 2. MySQL'e bulk_create
# 3. Foreign key ID'leri map et
```

**Risk**: YÃœKSEK - Kompleks, hata riski

**Ã–neri**: Method 1 (dumpdata/loaddata) tercih et

---

## ðŸ“‹ MODEL-MIGRATION TUTARLILIÄžI

### Kontrol Listesi

**TÃ¼m modeller iÃ§in migration var mÄ±?**

| App | Model SayÄ±sÄ± | Migration DosyasÄ± | Durum |
|-----|--------------|------------------|-------|
| accounts | 3 | 3 migration | âœ… |
| stores | 2 | 4 migration | âœ… |
| listings | 3 | 5 migration | âœ… |
| catalog | 2 | 3 migration | âœ… |
| cart | 0 | 1 migration (empty) | âœ… Session-based |
| orders | 2 | 2 migration | âœ… |
| reviews | 1 | 2 migration | âœ… |
| messaging | 3 | 3 migration | âœ… |
| moderation | 4 | 3 migration | âœ… |
| payments | 5 | 1 migration (__init__) | âš ï¸ |
| search | 2 | 2 migration | âœ… |
| shipping | 0 | 1 migration (empty) | âœ… BoÅŸ app |
| dashboards | 0 | 1 migration (empty) | âœ… BoÅŸ app |
| core | 0 | 1 migration (empty) | âœ… Model yok |

**Dikkat**: payments app'te 5 model var ama sadece __init__.py migration  
**Durum**: âš ï¸ KONTROL ET - Pending migration olabilir

**Kontrol Komutu**:
```bash
python manage.py makemigrations payments --check
```

**Beklenen**: No changes detected VEYA pending migration varsa oluÅŸtur

---

## ðŸš¨ BULGULAR & RÄ°SKLER

### KRÄ°TÄ°K SORUNLAR

1. **payments app migration eksikliÄŸi**
   - **Durum**: âš ï¸ 5 model var, migration __init__ only
   - **Risk**: YÃœKSEK - DB'de tablo olmayabilir
   - **Ã‡Ã¶zÃ¼m**: `python manage.py makemigrations payments`
   - **Test**: `python manage.py migrate --plan`

---

### ORTA RÄ°SKLER

2. **MySQL UniqueConstraint compatibility**
   - **Model**: messaging.Thread
   - **Durum**: Conditional unique constraint MySQL'de desteklenmez
   - **Risk**: ORTA - Duplicate thread oluÅŸabilir
   - **Ã‡Ã¶zÃ¼m**: PostgreSQL kullan VEYA application-level check

3. **Review signal performance**
   - **Durum**: Her review'da aggregate query
   - **Risk**: DÃœÅžÃœK - YavaÅŸlÄ±k (Ã§ok review varsa)
   - **Ã–neri**: Cache veya async optimize

---

### DÃœÅžÃœK RÄ°SKLER

4. **Signal idempotency**
   - **Durum**: âœ… Kontroller mevcut
   - **Risk**: YOK

5. **Migration rollback**
   - **Durum**: Django migration rollback destekliyor
   - **Risk**: DÃ¼ÅŸÃ¼k - Data migration yoksa gÃ¼venli

---

## âœ… Ã–NERÄ°LER

### YÃœKSEK Ã–NCELÄ°K

1. **payments app migration kontrolÃ¼**
   ```bash
   python manage.py makemigrations payments --check
   # EÄŸer pending var:
   python manage.py makemigrations payments
   ```

2. **Migration plan kontrolÃ¼**
   ```bash
   python manage.py migrate --plan
   # Pending yok olmalÄ±
   ```

---

### ORTA Ã–NCELÄ°K

3. **MySQL kullanÄ±yorsan**: Conditional unique constraint test et
   ```bash
   # messaging.Thread duplicate oluÅŸturma testi
   # Application-level validation ekle
   ```

4. **Performance**: Review signal'i optimize et
   - Cache store rating
   - Async job ile hesapla

---

### DÃœÅžÃœK Ã–NCELÄ°K

5. **Data migration** (Render â†’ cPanel):
   - Test dumpdata/loaddata flow
   - Backup oluÅŸtur

---

## ðŸŽ¯ DOÄžRULAMA KOMUTLARI

### Bash (cPanel)
```bash
# Migration status
python manage.py showmigrations

# Pending check
python manage.py makemigrations --check --dry-run

# Migration plan
python manage.py migrate --plan

# Database connection test
python scripts/test_db_connection.py
```

### PowerShell (Local)
```powershell
# Migration status
python manage.py showmigrations

# Pending check
python manage.py makemigrations --check --dry-run

# Migration plan
python manage.py migrate --plan
```

---

## âœ… SONUÃ‡

**Migration Health**: âœ… **Ä°YÄ°** (payments kontrol edilmeli)  
**Signal Safety**: âœ… **GÃœVENLI** (idempotent)  
**PostgreSQL Ready**: âœ… **TAM UYUMLU**  
**MySQL Ready**: âš ï¸ **TEST GEREKLÄ°** (UniqueConstraint)

**Kritik Sorun**: 1 (payments migration check)  
**Orta Risk**: 2 (MySQL uyumluluk, performance)  
**DÃ¼ÅŸÃ¼k Risk**: 2 (data migration, signal optimize)

**GO/NO-GO**: âœ… **GO** (payments migration check sonrasÄ±)

---

**HazÄ±rlayan**: AI Assistant  
**Tarih**: 2025-10-20  
**Durum**: TAMAMLANDI âœ…


